---
title: "Manual"
author: "Eleni Nisioti"
date: "May 15, 2017"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning= FALSE, message= FALSE, eval = FALSE)
knitr::opts_knit$set(root.dir="../..")
```

# How to perform an experiment using automl
This document describes the steps required to perform a machine learning experiment using our tool. These include preparation of the workspace and a call to the main interface defined in [experiment.R](../experiment.R). We will also inspect the internal workings of [build_script.R](../build_script.R), a script used to set up our tool.

## Get datasets
In order to perform an experiment one has to possess a classification dataset satisfying the following characteristics:

1. be a comma-delimited, .csv file with labels
2. include a two-level column labeled as "Class" 
3. declare all unknown values with " " (in order to read them as NAs)

We have collected a large library, consisting of 123 datasets, in order to train our tool. Of them, we have excluded 22 datasets for testing, which are available under [https://drive.google.com/open?id=0B5kUY54Gc5R1TkJUQWJ1V3Uzcnc](https://drive.google.com/open?id=0B5kUY54Gc5R1TkJUQWJ1V3Uzcnc). We urge users to download this file and unzip it under directory [workspace](../workspace).

Directory [workspace](../workspace) is very important, because it includes all information required by and generated from an experiment. Subdirectories [heuristics_repo](../workspace/heuristics_repo) and [HPP](../workspace/HPP) include information created during the design and training of our tool, namely data necessary for heuristically met decisions and hyperparameter prediction models respectively. Subdirectory [datasets_repo](../workspace/datasets_repo) contains datasets available for testing. Each time an experiment is performed, a respective subdirectory is created, containing all essential information generated by the experiment (which we will inspect in Section [Review experiment](#Review-experiment))

## Initiate experiment
We begin by supposing that you have acquired the folder 'datasets_repo' and possess a file [bank-additional.csv])(../workspace/datasets_repo/bank-additional.csv). 

You can initiate an experiment for this particular dataset by first setting the appropriate R working directory and then calling [experiment.R](../experiment.R) with the desired arguments.

```{r initiate_experiment}
setwd("automl")
system("Rscript experiment.R -e -d bank-additional.csv -p my_first_experiment")
```

This command instructs an experiment for dataset "bank-additional.csv" and creates subdirectory "project_my_first_experiment" under [workspace](../workspace). Flag "-e" means that an experiment is requested (instead of system training). We'll now dive deeper into the preparation performed upon initiation of an experiment:

```{r experiment_internal_buildE}
source("build_script.R")
```
The experiment begins by building the system. We'll analyze this step in Section [Build system](#Build-system).

```{r experiment_internal_flags}
option_list <- list(
  make_option( c("-d", "--dataset"), type = "character",
  default = "baboon_mating.csv", help = "dataset file name",
  metavar = "character"),
  make_option( c("-p", "--project"), type = "character", help = "name of new project",
default = NULL, metavar = "character"),
  make_option( c("-w", "--workspace"), type = "character",
             default = workspace_dir, help = "name of workspace directory",
             metavar = "character"), 
  make_option( c("-t", "--train"), action = "store_true", dest = "train"),
  make_option( c("-e", "--experiment"), action = "store_false", dest = "train"),
  make_option( c("-c", "--compare"), action = "store_true", dest = "compare", default = FALSE)
)

opt_parser <- OptionParser(option_list=option_list)
opt        <- parse_args(opt_parser)
```
The experiment procedes by defining the command-line arguments of our tool. To this end OptionParser of package [optparse](https://cran.r-project.org/web/packages/optparse/index.html) was used.


```{r experiment_internal_parser}
inputparser <- new('InputParser')
inputparser$parseCommand(options = opt)
```
Next, an object of class InputParser, defined in directory [middleman](../middleman). This object is the entry point of our system and is responsible for delegating the execution of the experiment 

## Build system 
In order to acquire a better insight of how the system works, we'll know follow the build procedure.

```{r build_setup_libs}
library_path <- "lib"
.libPaths(c( .libPaths(),library_path))
dir.create(library_path, showWarnings = FALSE)
repos_path <- "http://cran.rstudio.com/"
```

Build begins by setting the R .libpaths variable. In order to leave the user's configuration unaffected, all libraries required by our system will be installed under a system-specific directory [lib](../lib). We then define that all libraries will be downloaded from [cran](http://cran.rstudio.com/).

```{r build_install_libs}
if(!require(nnet))
{
  print("You are missing the package 'nnet', we will now try to install it...")
  install.packages("nnet", repos = repos_path, lib = library_path)
  library(nnet)
}
if(!require(ROCR))
{
  print("You are missing the package 'ROCR', we will now try to install it...")
  install.packages("ROCR", repos = repos_path, lib = library_path)
  library(ROCR)
}
if(!require(plot3D))
{
  print("You are missing the package 'plot3D', we will now try to install it...")
  install.packages("plot3D", repos = repos_path, lib = library_path)
  library(plot3D)
}
if(!require(akima))
{
  print("You are missing the package 'akima', we will now try to install it...")
  install.packages("akima", repos = repos_path, lib = library_path)
  library(akima)
}
if(!require(fields))
{
  print("You are missing the package 'fields', we will now try to install it...")
  install.packages("fields", repos = repos_path, lib = library_path)
  library(fields)
}
if(!require(ggplot2))
{
  print("You are missing the package 'ggpllot2', we will now try to install it...")
  install.packages("ggplot2", repos = repos_path, lib = library_path)
  library(ggplot2)
}
if(!require(plyr))
{
  print("You are missing the package 'plyr', we will now try to install it...")
  install.packages("plyr", repos = repos_path, lib = library_path)
  library(plyr)
}
if(!require(ranger))
{
  print("You are missing the package 'ranger', we will now try to install it...")
  install.packages("ranger", repos = repos_path, lib = library_path)
  library(ranger)
}
if(!require(optparse))
{
  print("You are missing the package 'optparse', we will now try to install it...")
  install.packages("optparse", repos = repos_path, lib = library_path)
  library(optparse)
}
if(!require(randomForest))
{
  print("You are missing the package 'randomForest', we will now try to install it...")
  install.packages("randomForest", repos = repos_path, lib = library_path)
  library(randomForest)
}
if(!require(doParallel))
{
  print("You are missing the package 'doParallel', we will now try to install it...")
  install.packages("doParallel", repos = repos_path , lib = library_path)
  library(doParallel)
}
if(!require(foreach))
{
  print("You are missing the package 'foreach', we will now try to install it...")
  install.packages("foreach", repos = repos_path, lib = library_path)
  library(foreach)
}
if(!require(methods))
{
  print("You are missing the package 'methods', we will now try to install it...")
  install.packages("methods", repos = repos_path, lib = library_path)
  library(methods)
}
if(!require(caret))
{
  print("You are missing the package 'caret', we will now try to install it...")
  install.packages("caret", dependencies = TRUE, repos = repos_path, lib = library_path)
  library(caret)
}
if(!require(FactoMineR))
{
  print("You are missing the package 'FactoMineR', we will now try to install it...")
  install.packages("FactoMineR", repos = repos_path, lib = library_path)
  library(FactoMineR)
}
if(!require(MASS))
{
  print("You are missing the package 'MASS', we will now try to install it...")
  install.packages("MASS", repos = repos_path, lib = library_path)
  library(MASS)
}
if(!require(coin))
{
  print("You are missing the package 'coin', we will now try to install it...")
  install.packages("coin", repos = repos_path, lib = library_path)
  library(coin)
}
if(!require(multcomp))
{
  print("You are missing the package 'multcomp', we will now try to install it...")
  install.packages("multcomp", repos = repos_path, lib = library_path)
  library(multcomp)
}
if(!require(colorspace))
{
  print("You are missing the package 'colorspace', we will now try to install it...")
  install.packages("colorspace", repos = repos_path, lib ="/home/elennisioti/thesis_ws/lib")
  library(colorspace)
}
if(!require(pROC))
{
  print("You are missing the package 'pROC', we will now try to install it...")
  install.packages("pROC", repos = repos_path, lib = library_path)
  library(pROC)
}
if(!require(e1071))
{
  print("You are missing the package 'e1071', we will now try to install it...")
  install.packages("e1071", repos = repos_path, lib = library_path)
  library(e1071)
}
if(!require(kernlab))
{
  print("You are missing the package 'kernlab', we will now try to install it...")
  install.packages("kernlab", repos = repos_path, lib = library_path)
  library(kernlab)
}
```
This long chunk of code checks if necessary packages are missing and installs them. Note that if the installation of a package fails, it can be performed manually.

```{r build_source}
source("middleman/FileManipulator.R")
source("classifier/GenericClassifier.R")
source("classifier/AnnClassifier.R")
source("classifier/BayesClassifier.R")
source("classifier/KnnClassifier.R")
source("classifier/TreeClassifier.R")
source("classifier/SvmClassifier.R")
source("preprocessor/FeatureEngineer.R")
source("preprocessor/InapRemover.R")
source("preprocessor/Normalizer.R")
source("preprocessor/DataCompressor.R")
source("mfExtractor/mf1Extractor.R")
source("mfExtractor/mf2Extractor.R")
source("optimizer/Optimizer.R")
source("evaluator/PerformanceEvaluator.R")
source("evaluator/HypothesisTester.R")
source("middleman/Expert.R")
source("classifier/Ensembler.R")
source("preprocessor/DataPrepare.R")
source("visualizer/FeatureVisualizer.R")
source("visualizer/PerformanceVisualizer.R")
source("middleman/Server.R")
source("middleman/InputParser.R")
```
Finally all our system's source files are sourced.

## Review experiment
The output of an experiment consists of a reusable ensemble model, as well as information produced during its various stages. This information is stored in 'experiment_info.Rdata' under the project's directory. The file includes an R list, which the user can process in order to extract the desired information as follows:

```{r load experiment_info, eval = TRUE}
load("automl/workspace/project_my_first_experiment/experiment_info.Rdata")
str(data)
```

In order to ensure a better-readable and intepretable output of our system a report document is offered after completion of the experiment. The above list is parsed by the R Markdown script [automl_report.Rmd](../automl_report.Rmd) and a [automl_report.html](../workspace/project_my_first_experiment/automl_report.html) is produced under the project's directory. 
